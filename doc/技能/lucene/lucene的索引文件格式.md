# 一、Lucene的索引层次结构

- 索引（index）  
   - 在lucene中一个索引是放在一个文件夹中的；  
   - 同一个文件夹中的所有文件构成一个lucene索引；  
- 段（segment）
   - 一个索引可以包含多个段，段与段之间是独立的，添加新文档可以生成新的段，不同的段可以合并；  
   - 具有相同前缀的文件属于同一个段；
   - segments.gen和segments_N是段的元数据文件，它们保存了段的属性信息；
- 文档（Document）
   - 文档是我们建索引的基本单位，不同的文档是保存在不同的段中的，一个段可以包含多篇文档；  
   - 新添加的文档是单独保存在一个新生成的段中的，随着段的合并，不同的文档合并到不同的段中；  
- 域（field）
   - 一篇文档包含不同类型的信息，可以分开索引，比如标题、时间、正文、作者等都可以保存在不同的域里；  
   - 不同域的索引方式可以不同；
- 词（Term）
   - 词是索引的最小单位，是经过词法分析和语言处理后的字符串；  
- 正向信息
   - lucene的索引结构中，保存了从索引一直到词的包含关系：索引（index） -> 段（segment） -> 文档（document） -> 域（field） -> 词（term）
   - 包含正向信息的文件有：  
      - segments_N保存了此索引包含多少个段，每个段包含多少篇文档；  
      - XXX.fdx、XXX.fdt保存了此段包含的所有文档，每篇文档包含了多少域，每个域保存了哪些信息；
      - XXX.fnm保存了此段包含了多少个域，每个域的名称及索引方式；
      - XXX.tvx、XXX.tvd、XXX.tvf保存了此段包含多少文档，每篇文档包含了多少域，每个域包含了多少次，每个词的字符串、位置等信息；
- 反向信息  
   -  lucene的索引结构中，保存了词典到倒排表的映射：词（Term） -> 文档（Document）
   - 包含反向信息的文件有：
      - XXX.tis、XXX.tii保存了词典，也即此段包含的所有的词按字典顺序的排序；  
      - XXX.frq：保存了倒排表，也即包含每个词的文档ID列表；
      - XXX.prx保存了倒排表中的每个词在包含此词的文档中位置；   

# 二、lucene的基本类型

- byte：最基本的类型，长8bit;  
- uint32：4个byte组成；  
- uint64：8个byte组成；  
- vint：变长的整数类型，包含多个byte，对于每个byte的8位，后7位表示数值，最高1位表示是否还有另一个byte；  
- chars：utf-8编码的一系列byte；  
- string：一个字符串首先是一个vint表示的表示此字符串包含的字符的格式，接着便是utf-8编码的字符序列chars；  

# 三、基本原则

1. 前缀后缀原则（Prefix+Suffix）   
   Lucene在反向索引中，要保存词典的信息，所有的词在词典中是按照字典顺序进行排列的，然而词典中包含了此文档中的几乎所有词，并且有的词还是非常的长的，这样索引文件会非常的大。  
   所谓前缀后缀原则，即当某个词和前一个词有共同的前缀的时候，后面的词仅仅保存前缀在此中的便宜（offset）,以及除前缀意外的字符串。

2. 差值规则（Delta）   
   在Lucene的反向索引中，需要保存很多整数类型的信息，比如文档ID号，比如词（Term）在文档中的位置等。
   整数类型是以VInt的格式存储的，随着数值的增大，每个数字占用的Byte的个数也逐渐的增多。所谓差值原则就是先后保存两个整数的时候，后面的整数仅仅保存和前面整数的差即可。
   
3. 或然跟随原则（A，B？）   
   Lucene的索引结构中存在这样的情况，某个值A后面可能存在某个值B，也可能不存在，需要一个标志来表示后面是否跟随者B。   
   在Lucene中，A的值左移一位，空出最后一位，作为标志位，来表示后面是否跟随B。

4. 跳跃表规则（Skip List）   
   为了提高查找的性能，Lucene在很多地方采取跳跃表的数据结构；   
   跳跃表是一种数据结构，它有以下几个特征：   
   - 元素是按顺序排列的，在Lucene中，或是按照字典顺序排列，或者按照从小到大的顺序排列；
   - 跳跃是有间隔的（Interval），也即每次跳跃的元素数，间隔是事先配置好的；
   - 跳跃表是有层次的（level），每一层的每隔指定间隔的元素构成上一层。
   
   
索引文件格式总体结构如下：
![blockchain](https://images2018.cnblogs.com/blog/1426944/201807/1426944-20180706203500917-149193956.png "Lucene索引文件格式总体结构")

# 四、具体格式
1. 正向信息   
   Index -> Segments(segments.gen, segments_N) -> Field(fnm, fdx, fdt) -> Term(tvx, tvd, tvf)
   1. 段的元数据信息(segments_N)   
      一个索引（Index）可以同时存在多个segments_N，然而当我们要打开一个索引的时候，必须选择一个打开，选择的顺序如下：   
         - 在所有的segments_N中选择N最大的一个；
         - 打开segments.gen，其中保存了当前的N值
2. 反向信息


