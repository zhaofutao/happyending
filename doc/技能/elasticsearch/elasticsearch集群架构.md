# 一、ElasticSearch介绍
    Elasticsearch是一个非常著名的开源搜索和分析系统，目前被广泛应用于互联网多种领域中，尤其在以下三个领域特别突出。
  - 搜索领域：相对于Solr，真正的后起之秀，成为很多搜索系统的不二之选；
  - Json文档数据库，相对于MongoDB，读写性能更加，而且支持更丰富的地理位置查询以及数字、文本的混合查询等。
  - 时序数据分析处理，目前是日志处理、监控数据的存储、分析和可视化方面做得非常好。
  
    Elasticsearch集群基本概念：
  - 节点（Node）：物理概念，一个运行的Elasticsearch实例，一般一台机器上一个进程；
  - 索引（Index）：逻辑概念，包含配置信息mapping和倒排正排数据文件，一个索引的数据文件会分布在多个节点上。
  - 分片（Shard）：为了支持更大量的数据，索引一般都会按某个维度分成多个部分，每个部分就是一个分片，分片被节点管理。一个节点会管理多个分片，这些分片可能属于一个索引，也可能属于不同索引。
  - 副本（Replica）：同一个分片的备份数据，一个分片可能有0或多个分贝，这些副本的数据保证强一致或最终一致。

# 二、Index流程
        建索引的时候，一个Doc先是经过路由规则定位到主分片，发送这个doc倒主分片上见索引，成功后再发送这个doc倒副本上建索引，等副本上建索引成功后才返回成功。
        当某个副本或主分片丢失（机器宕机、网络中断等）时，需要将丢失的分配从其他节点恢复回来，这时候就需要从其他副本全量拷贝这个分片的所有数据到新节点上构建新副本。
        当读请求量很大的时候，一个节点无法承载所有流量，这个时候就需要一个副本来分流查询压力，扩展查询能力。

# 三、Elasticsearch集群部署方式
![blockchain](/resource/images/elasticsearch部署方式.jpg)
    Elasticsearch支持两种部署方式：
  - 混合方式：默认    
        不考虑MasterNode的情况下，还有两种Node：Data Node和Transport Node，混合方式下，Data和Transport角色都位于同一个Node中。  
        当有index或query请求的时候，请求随机发送给任何一个Node，这台Node中会持有一个全局的路由表，通过路由表选择合适的Node，将请求发送给这些Node，然后等所有请求都返回后，合并结果，然后返回给用户。  
        好处是简单，易上手；  
        缺点是多种类型的请求会相互影响，在大集群中如果某一个Data Node出现热点，那么就会影响途径这个Data Node所有其他跨Node请求。
        Elasticsearch每个Node需要和其余的每个Node保持13个连接，这种情况下，混合方式集群的规模就会受限制。  
  - 分层部署  
        通过配置可以隔离开Node，设置部分Node为Transport Node，专门用来做请求转发和结果合并；其他Node可以设置为DataNode，专门用来做数据处理；  
        缺点是上手复杂，需要提前设置好Transport的数量；
        好处是角色相互独立，不会相互影响，一般Transport Node的流量是平均分配的，很少出现单台机器的CPU或流量被打满的情况，而DataNode由于处理数据，很容易出现单机资源被占满，如CPU、网络、磁盘等。
        角色独立后，只需要Transport 弄的连接所有的DataNode，而DataNode不需要和其他DataNode有连接。一个集群汇总DataNode的数量远大于TransportNode，这样集群的规模可以更大。另外，还可以分组，使TransportNode只连接固定分组的DataNode。
# 四、Elasticsearch数据层结构
        Elasticsearch的Index和Meta，目前支持存储在本地文件系统中，同时支持niofs、mmap、simplefs、smb等不同加载方式，性能最好的是直接将索引加载进内场的MMAP方式。
        Index和Meta都存在本地，会带来一个问题，当某一台机器宕机或磁盘损坏的时候，数据就丢失了，为了解决这个问题，可以使用副本功能。
          